AWSTemplateFormatVersion: 2010-09-09
Description: streams-dynamodb
Transform:
- AWS::Serverless-2016-10-31
Globals:
  Function:
    Tracing: Active
    Timeout: 180
    Environment:
      Variables:
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
        TABLE_NAME: qldb-bicycle-licence-sam
Resources:
  QldbStreamsDynamoDBLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/functions/qldb-streams-dynamodb-sam.handler
      Runtime: nodejs12.x
      MemorySize: 1024
      Events:
        Stream:
          Type: Kinesis
          Properties:
            Stream:
              Fn::GetAtt:
              - LicenceStreamKinesis
              - Arn
            StartingPosition: TRIM_HORIZON
            MaximumRetryAttempts: 10
      Policies:
      - AWSLambdaBasicExecutionRole
      - Version: 2012-10-17
        Statement:
        - Effect: Allow
          Action:
          - kinesis:ListStreams
          - kinesis:DescribeStream
          - kinesis:GetRecords
          - kinesis:GetShardIterator
          - kinesis:PutRecord
          Resource:
            Fn::GetAtt:
            - LicenceStreamKinesis
            - Arn
        - Effect: Allow
          Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          Resource:
            Fn::GetAtt:
            - BicycleLicenceTable
            - Arn
      CodeUri: QldbStreamsDynamoDBLambdaFunction
  BicycleLicenceTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    Properties:
      TableName: qldb-bicycle-licence-sam
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  LicenceStreamKinesis:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: LicenceStreamKinesis
      RetentionPeriodHours: 168
      ShardCount: 1
  LicenceStreamsKinesisRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: qldb.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: QLDBStreamDynamoDBKinesisPermissions
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - kinesis:ListShards
            - kinesis:DescribeStream
            - kinesis:PutRecord*
            Resource:
              Fn::GetAtt:
              - LicenceStreamKinesis
              - Arn
  LicenceQLDBStream:
    Type: AWS::QLDB::Stream
    DependsOn: LicenceStreamsKinesisRole
    Properties:
      InclusiveStartTime: '2020-05-29T00:00:00Z'
      KinesisConfiguration:
        AggregationEnabled: true
        StreamArn:
          Fn::GetAtt:
          - LicenceStreamKinesis
          - Arn
      LedgerName:
        Fn::ImportValue: qldb-bicycle-licence-sam
      RoleArn:
        Fn::GetAtt:
        - LicenceStreamsKinesisRole
        - Arn
      StreamName: qldb-licence-dynamodb-sam
      Tags:
      - Key: name
        Value: qldb-bicycle-licence-sam
